@page "/Doctor/AppointmentDetails"
@model CareSync.Pages.Doctor.AppointmentDetails
@using CareSync.Shared.Enums.Appointment

@{
    ViewData["Title"] = "Appointment Details";

    var isInProgress = Model.Status == AppointmentStatus_Enum.InProgress;
    var isCompleted  = Model.Status == AppointmentStatus_Enum.Completed;

    var isScheduledOrBeyond      = Model.Status >= AppointmentStatus_Enum.Scheduled;
    var isConsultationStarted    = Model.Status >= AppointmentStatus_Enum.InProgress && Model.Status != AppointmentStatus_Enum.Cancelled && Model.Status != AppointmentStatus_Enum.NoShow;
    var isConsultationCompleted  = Model.Status >= AppointmentStatus_Enum.Completed && Model.Status != AppointmentStatus_Enum.Cancelled && Model.Status != AppointmentStatus_Enum.NoShow;
    var isCancelledOrNoShow      = Model.Status == AppointmentStatus_Enum.Cancelled || Model.Status == AppointmentStatus_Enum.NoShow;
}

<form id="__antiForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section PageActions {
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="window.history.back()">
            <i class="ri-arrow-left-line me-1"></i>Back
        </button>

        <button id="startEndButton"
                class="btn @(isInProgress ? "btn-danger" : "btn-success") @(isCompleted ? "disabled" : string.Empty)"
                onclick="@(isCompleted ? "return false;" : (isInProgress ? "endConsultation()" : "startConsultation()"))">
            <i class="@(isInProgress ? "ri-stop-line" : "ri-play-line") me-1"></i>
            <span id="startEndButtonText">
                @(isInProgress ? "End Consultation"
                               : (isCompleted ? "Consultation Completed" : "Start Consultation"))
            </span>
        </button>

        @* <button class="btn btn-outline-primary" onclick="messagePatient()">
            <i class="ri-message-line me-1"></i>Message Patient
        </button> *@

        <button class="btn btn-outline-secondary" onclick="window.print()">
            <i class="ri-printer-line me-1"></i>Print
        </button>
    </div>
}

<div class="row gx-3">
    <div class="col-xl-8">
        <div class="card mb-3">
            <div class="card-header bg-primary-subtle">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="ri-calendar-check-line me-2"></i>Appointment Information
                    </h5>
                    <span class="badge bg-@((Model.Status.ToString() == "completed") ? "success" : "warning")">@Model.Status</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    @* <div class="col-md-6">
                        <small class="text-muted d-block">Appointment</small>
                        <strong class="text-primary">@Model.AppointmentNumber</strong>
                    </div> *@
                    <div class="col-md-6">
                        <small class="text-muted d-block">Date & Time</small>
                        <strong>@Model.AppointmentDate.ToString("MMMM dd, yyyy") - @Model.AppointmentTime</strong>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">Type</small>
                        <strong>@Model.AppointmentType</strong>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">Status</small>
                        <strong>@Model.Status</strong>
                    </div>
                    <div class="col-12">
                        <small class="text-muted d-block mb-1">Notes</small>
                        <p class="mb-0">@Model.Notes</p>
                    </div>
                    <div class="col-12">
                        <small class="text-muted d-block mb-1">Created On</small>
                        <p class="mb-0">@Model.CreatedOn.ToString("MMMM dd, yyyy hh:mm tt")</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Patient Info -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-user-line me-2"></i>Patient Information
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-3 align-items-center">
                    <img src="~/theme/images/default-patient.png"
                         class="img-5x rounded-circle" alt="Patient">
                    <div class="flex-grow-1">
                        <h5 class="mb-1">@Model.PatientName</h5>
                        <p class="text-muted mb-1">
                            Patient ID: P@Model.PatientId
                        </p>
                        <p class="text-muted mb-0">
                            @Model.PatientAge years • @Model.PatientContact • @Model.PatientEmail
                        </p>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small class="text-muted d-block">Gender</small>
                                <strong>@Model.Gender</strong>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block">Blood Group</small>
                                <strong>@Model.BloodGroup</strong>
                            </div>
                        </div>
                    </div>
                    <div>
                        <a class="btn btn-sm btn-outline-info"
                           href="/Admin/Patients/Profile?patientId=@Model.PatientId">
                            <i class="ri-eye-line me-1"></i>View Profile
                        </a>
                        <a class="btn btn-sm btn-outline-primary mt-2"
                           href="/Doctor/MedicalHistory?patientId=@Model.PatientId">
                            <i class="ri-file-list-3-line me-1"></i>Medical History
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medical Notes -->
        <!-- <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-file-text-line me-2"></i>Medical Notes & Diagnosis
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-primary mb-2">Diagnosis</h6>
                    <p class="text-muted mb-0">@Model.Diagnosis</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-primary mb-2">Treatment Plan</h6>
                    <p class="text-muted mb-0">@Model.TreatmentPlan</p>
                </div>
                <div>
                    <h6 class="text-primary mb-2">Doctor's Notes</h6>
                    <p class="text-muted mb-0">@Model.DoctorNotes</p>
                </div>
            </div>
        </div> -->

        <!-- Vitals -->
        <!-- <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-heart-pulse-line me-2"></i>Vitals
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <small class="text-muted d-block">Blood Pressure</small>
                        <strong>@Model.BloodPressure</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Heart Rate</small>
                        <strong>@Model.HeartRate bpm</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted d-block">Temperature</small>
                        <strong>@Model.Temperature�F</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prescriptions -->
        <!-- <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="ri-medicine-bottle-line me-2"></i>Prescriptions</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="downloadPrescription()">
                    <i class="ri-download-line me-1"></i>Download
                </button>
            </div>
            <div class="card-body">
                @if (Model.Prescriptions.Any())
                {
                    foreach (var p in Model.Prescriptions)
                    {
                        <div class="prescription-item border rounded-3 p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <div>@p</div>
                                <span class="badge bg-success">Active</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted">No prescriptions on record</div>
                }
            </div>
        </div> -->

        <!-- Lab Reports -->
        <!-- <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title"><i class="ri-test-tube-line me-2"></i>Lab Reports</h5>
            </div>
            <div class="card-body">
                @if (Model.LabReports.Any())
                {
                    <ul class="list-group">
                        @foreach (var l in Model.LabReports)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @l
                                <button class="btn btn-sm btn-outline-secondary">Download</button>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted">No lab reports found</div>
                }
            </div>
        </div> -->
    </div>

    <!-- Sidebar -->
    <div class="col-xl-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Actions</h6>
            </div>
            <div class="card-body d-grid gap-2">
                <button id="quickStartEndButton"
                    class="btn @(isInProgress ? "btn-danger" : "btn-primary") @(isCompleted ? "disabled" : string.Empty)"
                    onclick="@(isCompleted ? "return false;" : (isInProgress ? "endConsultation()" : "startConsultation()"))">
                <i class="@(isInProgress ? "ri-stop-line" : "ri-play-line") me-1"></i>
                <span id="quickStartEndButtonText">
                    @(isInProgress ? "End Consultation"
                                : (isCompleted ? "Consultation Completed" : "Start Consultation"))
                </span>
            </button>
                @if (isInProgress)
                {
                    <a class="btn btn-success" href="/Doctor/Checkup?appointmentId=@Model.AppointmentId">
                        <i class="ri-stethoscope-line me-1"></i> Go to Checkup Page
                    </a>
                }
                <a class="btn btn-outline-primary" href="/Doctor/MedicalHistory?patientId=@Model.PatientId">
                    <i class="ri-file-list-3-line me-1"></i>View Medical History
                </a>
                @* <button class="btn btn-outline-info" onclick="messagePatient()">
                    <i class="ri-message-line me-1"></i>Message Patient
                </button> *@
                <a class="btn btn-outline-secondary" href="/Doctor/Appointments">
                    <i class="ri-arrow-left-line me-1"></i>Back to Appointments
                </a>
            </div>
        </div>

        @* <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Appointment Timeline</h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker @(isScheduledOrBeyond ? "bg-success" : "bg-secondary")"></div>
                        <div class="timeline-content">
                            <small class="text-muted">@Model.AppointmentDate.ToString("MMM dd, yyyy") - @Model.AppointmentTime</small>
                            <p class="mb-0 small"><strong>Appointment Scheduled</strong></p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker @(isConsultationStarted ? "bg-info" : "bg-secondary")"></div>
                        <div class="timeline-content">
                            <small class="text-muted">--</small>
                            <p class="mb-0 small"><strong>Consultation In Progress</strong></p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker @(isConsultationCompleted ? "bg-success" : (isCancelledOrNoShow ? "bg-danger" : "bg-secondary"))"></div>
                        <div class="timeline-content">
                            <small class="text-muted">--</small>
                            @if (isCancelledOrNoShow)
                            {
                                <p class="mb-0 small"><strong>@(Model.Status == AppointmentStatus_Enum.NoShow ? "Patient Did Not Attend" : "Appointment Cancelled")</strong></p>
                            }
                            else if (isConsultationCompleted)
                            {
                                <p class="mb-0 small"><strong>Appointment Completed</strong></p>
                            }
                            else
                            {
                                <p class="mb-0 small"><strong>Awaiting Completion</strong></p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div> *@
    </div>
</div>

@section Scripts {
<script>
    // helper to get antiforgery token value rendered by @Html.AntiForgeryToken()
    function getAntiForgeryToken() {
        const tokenInput = document.querySelector('#__antiForm input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : '';
    }

    function setStatusBadge(newStatus) {
        const badge = document.querySelector('.card-header .badge') || document.querySelector('.badge');
        if (!badge) return;
        badge.textContent = newStatus;
        // update color classes (simple heuristic)
        badge.classList.remove('bg-success','bg-warning','bg-danger','bg-primary');
        if (newStatus.toLowerCase().includes('complete')) {
            badge.classList.add('bg-success');
        } else if (newStatus.toLowerCase().includes('inprogress') || newStatus.toLowerCase().includes('in progress')) {
            badge.classList.add('bg-warning');
        } else if (newStatus.toLowerCase().includes('cancel')) {
            badge.classList.add('bg-danger');
        } else {
            badge.classList.add('bg-primary');
        }
    }

    async function startConsultation() {
        const appointmentId = @Model.AppointmentId;
        if (!appointmentId || appointmentId <= 0) {
            alert('Invalid appointment id');
            return;
        }

        const token = getAntiForgeryToken();
        const form = new FormData();
        form.append('appointmentId', appointmentId);
        if (token) form.append('__RequestVerificationToken', token);

        const btn = document.getElementById('startEndButton');
        const txt = document.getElementById('startEndButtonText');
        btn.disabled = true;
        const prevHtml = btn.innerHTML;

        try {
            txt.textContent = 'Starting...';
            const resp = await fetch(window.location.pathname + '?handler=Start&id=' + appointmentId, {
                method: 'POST',
                body: form
            });

            // Many Razor handlers return a redirect or plain 200 without JSON.
            // Treat any successful HTTP status as a successful start.
            if (resp.ok) {
                setStatusBadge('InProgress');

                // After successfully starting the consultation, navigate to the
                // checkup page where the doctor will record findings and later
                // complete/stop the appointment.
                window.location.href = `/Doctor/Checkup?appointmentId=${appointmentId}`;
                return;
            } else {
                alert('Failed to start consultation');
                txt.textContent = 'Start Consultation';
            }
        } catch (err) {
            console.error(err);
            alert('Error starting consultation');
            txt.textContent = 'Start Consultation';
        } finally {
            btn.disabled = false;
        }
    }

    async function endConsultation() {
        const appointmentId = @Model.AppointmentId;
        if (!appointmentId || appointmentId <= 0) {
            alert('Invalid appointment id');
            return;
        }

        const token = getAntiForgeryToken();
        const form = new FormData();
        form.append('appointmentId', appointmentId);
        if (token) form.append('__RequestVerificationToken', token);

        const btn = document.getElementById('startEndButton');
        const txt = document.getElementById('startEndButtonText');
        btn.disabled = true;

        try {
            txt.textContent = 'Ending...';
            const resp = await fetch(window.location.pathname + '?handler=End&id=' + appointmentId, {
                method: 'POST',
                body: form
            });

            if (resp.ok) {
                setStatusBadge('Completed');

                // Header button -> Consultation Completed (disabled)
                btn.classList.remove('btn-danger', 'btn-success');
                btn.classList.add('btn-secondary', 'disabled');
                txt.textContent = 'Consultation Completed';
                btn.onclick = null;

                // Quick Actions button
                const qBtn = document.getElementById('quickStartEndButton');
                const qTxt = document.getElementById('quickStartEndButtonText');
                if (qBtn && qTxt) {
                    qBtn.classList.remove('btn-danger', 'btn-primary');
                    qBtn.classList.add('btn-secondary', 'disabled');
                    qTxt.textContent = 'Consultation Completed';
                    qBtn.onclick = null;
                }

                console.info('Consultation ended');
            } else {
                alert('Failed to end consultation');
                txt.textContent = 'End Consultation';
            }
        } catch (err) {
            console.error(err);
            alert('Error ending consultation');
            txt.textContent = 'End Consultation';
        } finally {
            btn.disabled = false;
        }
    }

    function messagePatient() {
        alert('Open messaging panel with patient.');
    }

    function downloadPrescription() {
        alert('Download prescription PDF (not implemented).');
    }
</script>

<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }
    .timeline-item { position: relative; margin-bottom: 16px; }
    .timeline-marker {
        position: absolute;
        left: -26px;
        top: 2px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #e9ecef;
    }
</style>
}