@page
@model CareSync.Pages.Doctor.PatientDetailsModel
@{
    ViewData["Title"] = "Patient Medical Details";
}

<!-- Breadcrumb -->
<div class="row">
    <div class="col-12">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h4 class="mb-0">Patient Medical Details</h4>
            <div>
                <a href="/Doctor/Patients" class="btn btn-outline-secondary me-2">
                    <i class="ri-arrow-left-line"></i> Back to Patients
                </a>
                <a href="/Doctor/Checkup?patientId=@Model.PatientId" class="btn btn-primary">
                    <i class="ri-stethoscope-line"></i> Start New Checkup
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Patient Profile Card -->
<div class="row gx-3">
    <div class="col-xxl-4 col-sm-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="text-center mb-3">
                    <img src="~/theme/images/patient.png" class="img-fluid rounded-circle mb-3" style="width: 150px; height: 150px;" alt="Patient">
                    <h5 class="mb-1">@Model.PatientName</h5>
                    <p class="text-muted mb-2">Patient ID: P@Model.PatientId.ToString("0000")</p>
                    <span class="badge bg-success-subtle text-success">Active Patient</span>
                </div>
                
                <hr>
                
                <div class="mb-2">
                    <strong><i class="ri-calendar-line me-2"></i>Age:</strong> @Model.Age years
                </div>
                <div class="mb-2">
                    <strong><i class="ri-user-line me-2"></i>Gender:</strong> @Model.Gender
                </div>
                <div class="mb-2">
                    <strong><i class="ri-drop-line me-2"></i>Blood Group:</strong> @Model.BloodGroup
                </div>
                <div class="mb-2">
                    <strong><i class="ri-heart-line me-2"></i>Marital Status:</strong> @Model.MaritalStatus
                </div>
                <div class="mb-2">
                    <strong><i class="ri-briefcase-line me-2"></i>Occupation:</strong> @Model.Occupation
                </div>
                
                <hr>
                
                <h6 class="mb-2">Emergency Contact</h6>
                <div class="mb-2">
                    <strong>Name:</strong> @Model.EmergencyContactName
                </div>
                <div class="mb-2">
                    <strong>Phone:</strong> @Model.EmergencyContactNumber
                </div>
                <div class="mb-2">
                    <strong>Relation:</strong> @Model.RelationshipToEmergency
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Statistics</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span>Total Appointments</span>
                    <strong class="text-primary">@Model.TotalAppointments</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Total Prescriptions</span>
                    <strong class="text-success">@Model.TotalPrescriptions</strong>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Chronic Conditions</span>
                    <strong class="text-warning">@Model.ChronicDiseases.Count</strong>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Last Visit</span>
                    <strong class="text-info">@Model.LastVisitDate.ToString("dd MMM yyyy")</strong>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xxl-8 col-sm-12">
        <!-- Tabs for Medical Information -->
        <div class="card mb-3">
            <div class="card-body">
                <ul class="nav nav-tabs" id="patientTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="vitals-tab" data-bs-toggle="tab" data-bs-target="#vitals" type="button" role="tab">
                            <i class="ri-heart-pulse-line"></i> Vitals History
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chronic-tab" data-bs-toggle="tab" data-bs-target="#chronic" type="button" role="tab">
                            <i class="ri-virus-line"></i> Chronic Diseases
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="prescriptions-tab" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">
                            <i class="ri-capsule-line"></i> Prescriptions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                            <i class="ri-calendar-check-line"></i> Appointments
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="patientTabContent">
                    <!-- Vitals History Tab -->
                    <div class="tab-pane fade show active" id="vitals" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Vitals History & Monitoring</h6>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addVitalsModal">
                                <i class="ri-add-line"></i> Add New Record
                            </button>
                        </div>
                        
                        @if (Model.VitalsHistory.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Height (cm)</th>
                                            <th>Weight (kg)</th>
                                            <th>BMI</th>
                                            <th>BP</th>
                                            <th>Pulse (bpm)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var vital in Model.VitalsHistory)
                                        {
                                            <tr>
                                                <td>@vital.RecordedDate.ToString("dd MMM yyyy")</td>
                                                <td>@vital.Height</td>
                                                <td>@vital.Weight</td>
                                                <td>@vital.BMI</td>
                                                <td>
                                                    @vital.BloodPressure
                                                    @if (vital.HasHighBloodPressure)
                                                    {
                                                        <i class="ri-alert-line text-danger" title="High BP"></i>
                                                    }
                                                </td>
                                                <td>@vital.PulseRate</td>
                                                <td>
                                                    @if (vital.IsDiabetic)
                                                    {
                                                        <span class="badge bg-warning-subtle text-warning">Diabetic</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success-subtle text-success">Normal</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Vitals Chart -->
                            <div class="mt-4">
                                <h6 class="mb-3">Weight & Blood Pressure Trend</h6>
                                <div id="vitalsChart"></div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="ri-information-line"></i> No vitals records found. Add the first record to start tracking patient health.
                            </div>
                        }
                    </div>

                    <!-- Chronic Diseases Tab -->
                    <div class="tab-pane fade" id="chronic" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Chronic Diseases Management</h6>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addChronicDiseaseModal">
                                <i class="ri-add-line"></i> Add Disease
                            </button>
                        </div>
                        
                        @if (Model.ChronicDiseases.Any())
                        {
                            <div class="row g-3">
                                @foreach (var disease in Model.ChronicDiseases)
                                {
                                    <div class="col-md-6">
                                        <div class="card border">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="mb-0">@disease.DiseaseName</h6>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-primary" onclick="editDisease(@disease.ChronicDiseaseID)">
                                                            <i class="ri-edit-line"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger" onclick="deleteDisease(@disease.ChronicDiseaseID)">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <p class="mb-1"><strong>Diagnosed:</strong> @disease.DiagnosedDate?.ToString("dd MMM yyyy")</p>
                                                <p class="mb-0">
                                                    <strong>Status:</strong> 
                                                    <span class="badge @GetStatusBadgeClass(disease.CurrentStatus)">
                                                        @disease.CurrentStatus
                                                    </span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success">
                                <i class="ri-heart-line"></i> No chronic diseases recorded. Patient appears healthy.
                            </div>
                        }
                    </div>

                    <!-- Prescriptions Tab -->
                    <div class="tab-pane fade" id="prescriptions" role="tabpanel">
                        <h6 class="mb-3">Prescription History</h6>
                        
                        @if (Model.PrescriptionsHistory.Any())
                        {
                            <div class="accordion" id="prescriptionAccordion">
                                @foreach (var prescription in Model.PrescriptionsHistory)
                                {
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#prescription@(prescription.PrescriptionID)">
                                                <div class="w-100 d-flex justify-content-between align-items-center pe-3">
                                                    <span>Prescription #@prescription.PrescriptionID - @prescription.CreatedOn.ToString("dd MMM yyyy")</span>
                                                    <span class="badge bg-primary-subtle text-primary">By @prescription.DoctorName</span>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="prescription@(prescription.PrescriptionID)" class="accordion-collapse collapse" data-bs-parent="#prescriptionAccordion">
                                            <div class="accordion-body">
                                                <div class="mb-3">
                                                    <strong>General Notes:</strong> @prescription.Notes
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Medicine</th>
                                                                <th>Dosage</th>
                                                                <th>Frequency</th>
                                                                <th>Duration</th>
                                                                <th>Instructions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var item in prescription.Items)
                                                            {
                                                                <tr>
                                                                    <td>@item.MedicineName</td>
                                                                    <td>@item.Dosage</td>
                                                                    <td>@item.Frequency</td>
                                                                    <td>@item.DurationDays days</td>
                                                                    <td>@item.Instructions</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="ri-information-line"></i> No prescriptions found for this patient.
                            </div>
                        }
                    </div>

                    <!-- Appointments Tab -->
                    <div class="tab-pane fade" id="appointments" role="tabpanel">
                        <h6 class="mb-3">Appointment History</h6>
                        
                        @if (Model.AppointmentsHistory.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Date & Time</th>
                                            <th>Type</th>
                                            <th>Reason</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var appointment in Model.AppointmentsHistory)
                                        {
                                            <tr>
                                                <td>@appointment.AppointmentID.ToString("000")</td>
                                                <td>@appointment.AppointmentDate.ToString("dd MMM yyyy, hh:mm tt")</td>
                                                <td>@appointment.AppointmentType</td>
                                                <td>@appointment.Reason</td>
                                                <td>
                                                    <span class="badge @GetAppointmentStatusBadge(appointment.Status)">
                                                        @appointment.Status
                                                    </span>
                                                </td>
                                                <td>
                                                    <a href="/Doctor/Checkup?appointmentId=@appointment.AppointmentID" class="btn btn-sm btn-outline-primary">
                                                        <i class="ri-eye-line"></i> View
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="ri-information-line"></i> No appointment history found.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Vitals Modal -->
<div class="modal fade" id="addVitalsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Vitals Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="AddVitals">
                <input type="hidden" name="patientId" value="@Model.PatientId" />
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Height (cm)</label>
                            <input type="number" step="0.1" class="form-control" name="height" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" step="0.1" class="form-control" name="weight" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Blood Pressure</label>
                            <input type="text" class="form-control" name="bloodPressure" placeholder="e.g., 120/80" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Pulse Rate (bpm)</label>
                            <input type="number" class="form-control" name="pulseRate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Is Diabetic?</label>
                            <select class="form-select" name="isDiabetic">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Has High Blood Pressure?</label>
                            <select class="form-select" name="hasHighBloodPressure">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Record</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Chronic Disease Modal -->
<div class="modal fade" id="addChronicDiseaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Chronic Disease</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="AddChronicDisease">
                <input type="hidden" name="patientId" value="@Model.PatientId" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Disease Name</label>
                        <input type="text" class="form-control" name="diseaseName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Diagnosed Date</label>
                        <input type="date" class="form-control" name="diagnosedDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Status</label>
                        <select class="form-select" name="currentStatus" required>
                            <option value="Controlled">Controlled</option>
                            <option value="Uncontrolled">Uncontrolled</option>
                            <option value="In Remission">In Remission</option>
                            <option value="Progressive">Progressive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Disease</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/theme/vendor/apex/apexcharts.css">
}

@section Scripts {
    <script src="~/theme/vendor/apex/apexcharts.min.js"></script>
    <script>
        // Initialize Vitals Chart
        document.addEventListener('DOMContentLoaded', function() {
            var vitalsChartOptions = {
                chart: {
                    type: 'line',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                series: [
                    {
                        name: 'Weight (kg)',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.VitalsHistory.Select(v => v.Weight).ToList()))
                    },
                    {
                        name: 'Systolic BP',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.VitalsHistory.Select(v => {
                            var parts = v.BloodPressure?.Split('/');
                            return parts != null && parts.Length > 0 ? int.Parse(parts[0]) : 0;
                        }).ToList()))
                    }
                ],
                xaxis: {
                    categories: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.VitalsHistory.Select(v => v.RecordedDate.ToString("dd MMM")).ToList()))
                },
                colors: ['#1e88e5', '#fb8c00'],
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                markers: {
                    size: 4
                }
            };
            
            var vitalsChart = new ApexCharts(document.querySelector("#vitalsChart"), vitalsChartOptions);
            vitalsChart.render();
        });
        
        function editDisease(id) {
            alert('Edit disease #' + id + ' - This will open an edit modal');
        }
        
        function deleteDisease(id) {
            if (confirm('Are you sure you want to delete this chronic disease record?')) {
                fetch(`/api/chronic-diseases/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            }
        }
    </script>
}

@functions {
    private string GetStatusBadgeClass(string? status)
    {
        return status switch
        {
            "Controlled" => "bg-success-subtle text-success",
            "Uncontrolled" => "bg-danger-subtle text-danger",
            "In Remission" => "bg-info-subtle text-info",
            "Progressive" => "bg-warning-subtle text-warning",
            _ => "bg-secondary-subtle text-secondary"
        };
    }
    
    private string GetAppointmentStatusBadge(string status)
    {
        return status switch
        {
            "Completed" => "bg-success-subtle text-success",
            "Scheduled" => "bg-primary-subtle text-primary",
            "Cancelled" => "bg-danger-subtle text-danger",
            "In-Progress" => "bg-warning-subtle text-warning",
            _ => "bg-secondary-subtle text-secondary"
        };
    }
}
