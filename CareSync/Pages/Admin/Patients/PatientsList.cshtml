@page "/Admin/Patients/PatientsList"
@model CareSync.Pages.Admin.Patients.PatientsListModel
@{
    ViewData["Title"] = "Patients Management";
}

@section Breadcrumb {
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="~/Admin/Dashboard">
                <i class="ri-home-3-line"></i>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="~/Admin/Patients/PatientsList">Patients</a>
        </li>
        <li class="breadcrumb-item text-primary" aria-current="page">
            All Patients
        </li>
    </ol>
}

@section PageActions {
    <div class="d-flex gap-2">
        <a href="~/Admin/Patients/Create" class="btn btn-primary">
            <i class="ri-user-add-line me-2"></i>Add Patient
        </a>
        <button class="btn btn-outline-secondary" onclick="exportPatients()">
            <i class="ri-download-line me-2"></i>Export
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                <i class="ri-filter-line me-2"></i>Filter
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?searchTerm=@Model.SearchTerm">All Patients</a></li>
                <li><a class="dropdown-item" href="?isActive=true&searchTerm=@Model.SearchTerm&bloodGroup=@Model.BloodGroup">Active</a></li>
                <li><a class="dropdown-item" href="?isActive=false&searchTerm=@Model.SearchTerm&bloodGroup=@Model.BloodGroup">Inactive</a></li>
                <li><a class="dropdown-item" href="?searchTerm=@Model.SearchTerm&isActive=@Model.IsActive">All Blood Groups</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="?bloodGroup=O%2B&searchTerm=@Model.SearchTerm&isActive=@Model.IsActive">O+</a></li>
                <li><a class="dropdown-item" href="?bloodGroup=A%2B&searchTerm=@Model.SearchTerm&isActive=@Model.IsActive">A+</a></li>
                <li><a class="dropdown-item" href="?bloodGroup=B%2B&searchTerm=@Model.SearchTerm&isActive=@Model.IsActive">B+</a></li>
                <li><a class="dropdown-item" href="?bloodGroup=AB%2B&searchTerm=@Model.SearchTerm&isActive=@Model.IsActive">AB+</a></li>
            </ul>
        </div>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="ri-check-line me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="ri-error-warning-line me-2"></i>@TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Statistics Cards -->
<div class="row gx-3 mb-4">
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-primary rounded-circle me-3">
                        <div class="icon-box md bg-primary-lighten rounded-5">
                            <i class="ri-user-heart-line fs-4 text-primary"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@(Model.PatientStats?.TotalPatients ?? 0)</h1>
                        <p class="m-0">Total Patients</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-success rounded-circle me-3">
                        <div class="icon-box md bg-success-lighten rounded-5">
                            <i class="ri-user-smile-line fs-4 text-success"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@(Model.PatientStats?.ActivePatients ?? 0)</h1>
                        <p class="m-0">Active</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-info rounded-circle me-3">
                        <div class="icon-box md bg-info-lighten rounded-5">
                            <i class="ri-user-add-line fs-4 text-info"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@(Model.PatientStats?.NewPatientsThisMonth ?? 0)</h1>
                        <p class="m-0">New This Month</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-warning rounded-circle me-3">
                        <div class="icon-box md bg-warning-lighten rounded-5">
                            <i class="ri-calendar-check-line fs-4 text-warning"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@(Model.PatientStats?.AppointmentsToday ?? 0)</h1>
                        <p class="m-0">Appointments Today</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Patient Registration Trends -->
    <div class="col-xl-8 col-lg-7 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-line-chart-line me-2"></i>Patient Registration Trends
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-height">
                    <div id="patientTrends"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Age Distribution -->
    <div class="col-xl-4 col-lg-5 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-pie-chart-line me-2"></i>Age Groups
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-height-sm">
                    <div id="ageDistribution"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Blood Groups and Gender Distribution -->
<div class="row mb-4">
    <div class="col-xl-6 col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-drop-line me-2"></i>Blood Group Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    @if (Model.PatientStats?.PatientsByBloodGroup != null)
                    {
                        var bloodGroups = new[] { "O+", "A+", "B+", "AB+" };
                        var colors = new[] { "danger", "primary", "success", "warning" };
                        
                        @for (int i = 0; i < bloodGroups.Length; i++)
                        {
                            var bloodGroup = bloodGroups[i];
                            var color = colors[i];
                            var count = Model.PatientStats.PatientsByBloodGroup.ContainsKey(bloodGroup) 
                                ? Model.PatientStats.PatientsByBloodGroup[bloodGroup] : 0;
                            
                            <div class="col-3">
                                <div class="text-center p-3 border rounded">
                                    <div class="icon-box md bg-@(color)-lighten rounded-circle mx-auto mb-2">
                                        <i class="ri-drop-fill text-@color"></i>
                                    </div>
                                    <h4 class="text-@color">@count</h4>
                                    <p class="mb-0">@bloodGroup</p>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12 text-center">
                            <p class="text-muted">No blood group data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-6 col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-bar-chart-line me-2"></i>Gender & Marital Status
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-height-sm">
                    <div id="genderChart"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patients Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="ri-team-line me-2"></i>All Patients
                </h5>
                <div class="d-flex gap-2">
                    <form method="get" class="input-group" style="width: 250px;">
                        <input type="text" class="form-control" placeholder="Search patients..." 
                               name="searchTerm" value="@Model.SearchTerm" id="searchInput">
                        <input type="hidden" name="bloodGroup" value="@Model.BloodGroup" />
                        <input type="hidden" name="isActive" value="@Model.IsActive" />
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="ri-search-line"></i>
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="patientsTable">
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Contact Info</th>
                                <th>Medical Info</th>
                                <th>Last Visit</th>
                                <th>Assigned Doctor</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Patients.Any())
                            {
                                @foreach (var patient in Model.Patients)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                @if (!string.IsNullOrEmpty(patient.ProfileImage))
                                                {
                                                    <img src="@patient.ProfileImage" class="rounded-circle me-3" width="40" height="40" alt="Patient">
                                                }
                                                else
                                                {
                                                    <div class="rounded-circle bg-primary-light d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                        <i class="ri-user-line text-primary"></i>
                                                    </div>
                                                }
                                                <div>
                                                    <h6 class="mb-0">@patient.FullName</h6>
                                                    <small class="text-muted">ID: P@patient.PatientID.ToString("D3")</small>
                                                    <br><small class="text-primary">Age: @(patient.Age ?? 0), @patient.Gender</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <span class="fw-bold">@patient.Email</span><br>
                                                <small class="text-muted">@patient.PhoneNumber</small><br>
                                                <small class="text-muted">Member Since: @patient.CreatedOn.ToString("MMM dd, yyyy")</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                @if (!string.IsNullOrEmpty(patient.BloodGroup))
                                                {
                                                    <span class="badge bg-danger-light text-danger mb-1">@patient.BloodGroup</span><br>
                                                }
                                                <small class="text-muted">@patient.MaritalStatus</small><br>
                                                @if (!string.IsNullOrEmpty(patient.Occupation))
                                                {
                                                    <small class="text-info">@patient.Occupation</small>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                @if (patient.LastVisit.HasValue)
                                                {
                                                    <span class="fw-bold">@patient.LastVisit.Value.ToString("MMM dd, yyyy")</span><br>
                                                    <small class="text-muted">@((DateTime.Now - patient.LastVisit.Value).Days) days ago</small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">No visits yet</span>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <small class="text-muted">Total Appointments</small><br>
                                                <span class="fw-bold">@patient.TotalAppointments</span>
                                            </div>
                                        </td>
                                        <td>
                                            @if (patient.IsActive)
                                            {
                                                <span class="badge bg-success">Active</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Inactive</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="dropdown">
                                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="ri-more-2-line"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="/Admin/Patients/Profile?id=@patient.PatientID"><i class="ri-eye-line me-2"></i>View Profile</a></li>
                                                    <li><a class="dropdown-item" href="/Admin/Patients/Edit?id=@patient.PatientID"><i class="ri-edit-line me-2"></i>Edit Patient</a></li>
                                                    <li><a class="dropdown-item" href="/Admin/Patients/MedicalRecords?patientId=@patient.PatientID"><i class="ri-file-text-line me-2"></i>Medical Records</a></li>
                                                    <li><a class="dropdown-item" href="/Admin/Patients/Appointments?patientId=@patient.PatientID"><i class="ri-calendar-line me-2"></i>Appointments</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form method="post" asp-page-handler="DeletePatient" class="d-inline" 
                                                              onsubmit="return confirm('Are you sure you want to delete this patient? This action cannot be undone.');">
                                                            <input type="hidden" name="userId" value="@patient.UserID" />
                                                            <input type="hidden" name="patientId" value="@patient.PatientID" />
                                                            <button type="submit" class="dropdown-item text-danger">
                                                                <i class="ri-delete-bin-line me-2"></i>Delete Patient
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="ri-user-line fs-1 text-muted"></i>
                                        <p class="text-muted mt-2">No patients found</p>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        @{
                            var startIndex = (Model.CurrentPage - 1) * Model.PageSize + 1;
                            var endIndex = Math.Min(Model.CurrentPage * Model.PageSize, Model.PatientStats?.TotalPatients ?? 0);
                        }
                        <span class="text-muted">Showing @startIndex to @endIndex of @(Model.PatientStats?.TotalPatients ?? 0) patients</span>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="?page=@(Model.CurrentPage - 1)&bloodGroup=@Model.BloodGroup&isActive=@Model.IsActive&searchTerm=@Model.SearchTerm">
                                    <i class="ri-arrow-left-s-line"></i>
                                </a>
                            </li>
                            @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="?page=@i&bloodGroup=@Model.BloodGroup&isActive=@Model.IsActive&searchTerm=@Model.SearchTerm">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" href="?page=@(Model.CurrentPage + 1)&bloodGroup=@Model.BloodGroup&isActive=@Model.IsActive&searchTerm=@Model.SearchTerm">
                                    <i class="ri-arrow-right-s-line"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- ApexCharts JS -->
    <script src="~/theme/vendor/apex/apexcharts.min.js"></script>
    
    <script>
        // Patient Registration Trends Chart
        var patientTrendsOptions = {
            chart: {
                height: 300,
                type: "line",
                toolbar: {
                    show: false,
                },
            },
            dataLabels: {
                enabled: false,
            },
            fill: {
                type: 'solid',
                opacity: [0.1, 1],
            },
            stroke: {
                curve: "smooth",
                width: [0, 5]
            },
            series: [{
                name: 'New Patients',
                type: 'area',
                data: [@Html.Raw(Model.RegistrationTrends?.MonthlyData != null ? string.Join(", ", Model.RegistrationTrends.MonthlyData.Select(m => m.Count)) : "0")]
            }, {
                name: 'Return Patients',
                type: 'line',
                data: [@Html.Raw(Model.RegistrationTrends?.MonthlyData != null ? string.Join(", ", Model.RegistrationTrends.MonthlyData.Select(m => "0")) : "0")]
            }],
            grid: {
                borderColor: "#d8dee6",
                strokeDashArray: 5,
            },
            xaxis: {
                categories: [@Html.Raw(Model.RegistrationTrends?.MonthlyData != null ? string.Join(", ", Model.RegistrationTrends.MonthlyData.Select(m => $"\"{m.MonthName}\"")) : "\"\"")],
            },
            colors: ["#0d6efd", "#198754"],
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val + " patients";
                    },
                },
            },
        };

        var patientTrendsChart = new ApexCharts(document.querySelector("#patientTrends"), patientTrendsOptions);
        patientTrendsChart.render();

        // Age Distribution Chart
        var ageOptions = {
            chart: {
                height: 250,
                type: 'donut',
            },
            series: [@Html.Raw(Model.AgeDistribution != null ? string.Join(", ", Model.AgeDistribution.GetSeriesData()) : "0, 0, 0, 0, 0")],
            labels: ['0-18', '19-35', '36-50', '51-65', '65+'],
            colors: ['#0d6efd', '#198754', '#ffc107', '#fd7e14', '#dc3545'],
            legend: {
                position: 'bottom',
                horizontalAlign: 'center',
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '70%'
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (val) {
                    return Math.round(val) + "%"
                }
            }
        };

        var ageChart = new ApexCharts(document.querySelector("#ageDistribution"), ageOptions);
        ageChart.render();

        // Gender Chart
        var genderOptions = {
            chart: {
                height: 250,
                type: 'bar',
                toolbar: {
                    show: false,
                },
            },
            series: [{
                name: 'Count',
                data: [@Html.Raw(Model.Demographics != null ? string.Join(", ", Model.Demographics.GetGenderMaritalData()) : "0, 0, 0, 0, 0, 0")]
            }],
            xaxis: {
                categories: ['Female', 'Male', 'Married', 'Single', 'Divorced', 'Widowed'],
            },
            colors: ['#0d6efd'],
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                },
            },
            dataLabels: {
                enabled: false
            },
            grid: {
                borderColor: "#d8dee6",
                strokeDashArray: 5,
            }
        };

        var genderChart = new ApexCharts(document.querySelector("#genderChart"), genderOptions);
        genderChart.render();

        // Export function - implement actual export logic
        function exportPatients() {
            // TODO: Implement actual export functionality
            console.log('Export functionality to be implemented');
            alert('Export functionality will be available soon!');
        }
    </script>

    <style>
        .chart-height {
            height: 300px;
        }
        
        .chart-height-sm {
            height: 250px;
        }
        
        .icon-box {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-box.md {
            width: 40px;
            height: 40px;
        }
        
        .bg-primary-lighten {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        .bg-success-lighten {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        
        .bg-warning-lighten {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }
        
        .bg-info-lighten {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
        
        .bg-danger-lighten {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        
        .bg-primary-light {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        .bg-danger-light {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
    </style>
}
