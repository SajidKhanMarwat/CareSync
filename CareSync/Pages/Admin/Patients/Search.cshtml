@page "/Admin/Patients/Search"
@model CareSync.Pages.Admin.Patients.SearchModel
@{
    ViewData["Title"] = "Search Patients";
}

@section Breadcrumb {
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="~/Admin/Dashboard">
                <i class="ri-home-3-line"></i>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="~/Admin/Patients/PatientsList">Patient Management</a>
        </li>
        <li class="breadcrumb-item text-primary" aria-current="page">
            Search Patients
        </li>
    </ol>
}

@section PageActions {
    <div class="d-flex gap-2">
        <a href="~/Admin/Patients/PatientsList" class="btn btn-outline-secondary">
            <i class="ri-arrow-left-line me-2"></i>Back to All Patients
        </a>
        <a href="~/Admin/Patients/Create" class="btn btn-primary">
            <i class="ri-user-add-line me-2"></i>Add New Patient
        </a>
    </div>
}

<!-- Advanced Search Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-search-2-line me-2"></i>Advanced Patient Search
                </h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="Search">
                    <div class="row g-3">
                        <!-- Basic Information -->
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="ri-user-line me-2"></i>Basic Information
                            </h6>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Search Term</label>
                            <input type="text" class="form-control" asp-for="SearchRequest.SearchTerm" 
                                   placeholder="Search by name, email, phone, or patient ID">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Gender</label>
                            <select class="form-select" asp-for="SearchRequest.Gender">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Medical Information -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary mb-3">
                                <i class="ri-heart-pulse-line me-2"></i>Medical Information
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Blood Group</label>
                            <select class="form-select" asp-for="SearchRequest.BloodGroup">
                                <option value="">All Blood Groups</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Min Age</label>
                            <input type="number" class="form-control" asp-for="SearchRequest.MinAge" min="0" max="150">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Max Age</label>
                            <input type="number" class="form-control" asp-for="SearchRequest.MaxAge" min="0" max="150">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Patient Status</label>
                            <select class="form-select" asp-for="SearchRequest.IsActive">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>

                        <!-- Date Filters -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary mb-3">
                                <i class="ri-calendar-line me-2"></i>Date Filters
                            </h6>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Last Visit From</label>
                            <input type="date" class="form-control" asp-for="SearchRequest.LastVisitFrom">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Last Visit To</label>
                            <input type="date" class="form-control" asp-for="SearchRequest.LastVisitTo">
                        </div>

                        <!-- Search Actions -->
                        <div class="col-12 mt-4">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="ri-search-line me-2"></i>Search Patients
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearSearchForm()">
                                    <i class="ri-refresh-line me-2"></i>Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Quick Search Options -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-flashlight-line me-2"></i>Quick Search Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-2">
                        <form method="post" asp-page-handler="QuickSearch">
                            <input type="hidden" name="type" value="all" />
                            <button type="submit" class="btn btn-outline-dark w-100">
                                <i class="ri-group-line me-2"></i>All Patients
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="post" asp-page-handler="QuickSearch">
                            <input type="hidden" name="type" value="active" />
                            <button type="submit" class="btn btn-outline-success w-100">
                                <i class="ri-checkbox-circle-line me-2"></i>Active Only
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="post" asp-page-handler="QuickSearch">
                            <input type="hidden" name="type" value="new" />
                            <button type="submit" class="btn btn-outline-info w-100">
                                <i class="ri-user-add-line me-2"></i>New This Week
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="post" asp-page-handler="QuickSearch">
                            <input type="hidden" name="type" value="appointments" />
                            <button type="submit" class="btn btn-outline-primary w-100">
                                <i class="ri-calendar-check-line me-2"></i>Has Appointments
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="post" asp-page-handler="QuickSearch">
                            <input type="hidden" name="type" value="overdue" />
                            <button type="submit" class="btn btn-outline-warning w-100">
                                <i class="ri-time-line me-2"></i>Overdue Visits
                            </button>
                        </form>
                    </div>
                    <div class="col-md-2">
                        <form method="post" asp-page-handler="QuickSearch">
                            <input type="hidden" name="type" value="inactive" />
                            <button type="submit" class="btn btn-outline-secondary w-100">
                                <i class="ri-user-unfollow-line me-2"></i>Inactive
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Results -->
@if (Model.SearchResult != null)
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="ri-search-eye-line me-2"></i>Search Results
                        <span class="badge bg-primary ms-2">@Model.SearchResult.TotalCount</span>
                    </h5>
                    <div class="d-flex gap-2">
                        <form method="post" asp-page-handler="Export">
                            <button type="submit" class="btn btn-outline-success btn-sm">
                                <i class="ri-download-line me-2"></i>Export Results
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.SearchResult.Patients.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient ID</th>
                                        <th>Name</th>
                                        <th>Age/Gender</th>
                                        <th>Contact</th>
                                        <th>Blood Group</th>
                                        <th>Last Visit</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var patient in Model.SearchResult.Patients)
                                    {
                                        <tr>
                                            <td><span class="fw-bold text-primary">@patient.PatientCode</span></td>
                                            <td>@patient.FullName</td>
                                            <td>@Model.GetAgeDisplay(patient.Age, patient.DateOfBirth) / @patient.Gender</td>
                                            <td>@patient.PhoneNumber</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(patient.BloodGroup))
                                                {
                                                    <span class="badge bg-danger">@patient.BloodGroup</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>@Model.GetLastVisitDisplay(patient.LastVisit)</td>
                                            <td>
                                                <span class="badge bg-@(patient.IsActive ? "success" : "secondary")">
                                                    @(patient.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                                        <i class="ri-more-2-line"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" href="/Admin/Patients/Profile?id=@patient.PatientID">
                                                                <i class="ri-eye-line me-2"></i>View Profile
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="/Admin/Patients/Edit?id=@patient.PatientID">
                                                                <i class="ri-edit-line me-2"></i>Edit Patient
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" href="/Admin/Appointments/Book?patientId=@patient.PatientID">
                                                                <i class="ri-calendar-line me-2"></i>Book Appointment
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <form method="post" asp-page="/Admin/Patients/PatientsList" asp-page-handler="DeletePatient" class="d-inline">
                                                                <input type="hidden" name="userId" value="@patient.UserID" />
                                                                <input type="hidden" name="patientId" value="@patient.PatientID" />
                                                                <button type="submit" class="dropdown-item text-danger" 
                                                                        onclick="return confirm('Are you sure you want to delete this patient?');">
                                                                    <i class="ri-delete-bin-line me-2"></i>Delete Patient
                                                                </button>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        @if (Model.SearchResult.TotalPages > 1)
                        {
                            <nav aria-label="Search results pagination" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item @(Model.SearchResult.HasPreviousPage ? "" : "disabled")">
                                        <a class="page-link" href="?page=@(Model.SearchResult.PageNumber - 1)&q=@Model.SearchRequest.SearchTerm">
                                            Previous
                                        </a>
                                    </li>
                                    
                                    @for (int i = 1; i <= Math.Min(Model.SearchResult.TotalPages, 10); i++)
                                    {
                                        <li class="page-item @(i == Model.SearchResult.PageNumber ? "active" : "")">
                                            <a class="page-link" href="?page=@i&q=@Model.SearchRequest.SearchTerm">@i</a>
                                        </li>
                                    }
                                    
                                    <li class="page-item @(Model.SearchResult.HasNextPage ? "" : "disabled")">
                                        <a class="page-link" href="?page=@(Model.SearchResult.PageNumber + 1)&q=@Model.SearchRequest.SearchTerm">
                                            Next
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        }
                    }
                    else
                    {
                        <div class="text-center mt-3">
                            <i class="ri-search-line text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-2">No patients found</h5>
                            <p class="text-muted">Try adjusting your search criteria</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function clearSearchForm() {
            window.location.href = '/Admin/Patients/Search';
        }
    </script>

    <style>
        .border-dashed {
            border-style: dashed !important;
        }
    </style>
}
