@page "/Admin/PatientAppointments"
@model CareSync.Pages.Admin.PatientAppointmentsModel
@{
    ViewData["Title"] = "Patient Appointments";
}

@section Breadcrumb {
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="~/Admin/Dashboard">
                <i class="ri-home-3-line"></i>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="~/Admin/Patients">Patients</a>
        </li>
        <li class="breadcrumb-item">
            <a href="~/Admin/PatientProfile?id=@Model.Patient?.PatientID">@Model.Patient?.FullName</a>
        </li>
        <li class="breadcrumb-item text-primary" aria-current="page">
            Appointments
        </li>
    </ol>
}

@section PageActions {
    <div class="d-flex gap-2">
        <a href="~/Admin/BookAppointment?patientId=@Model.Patient?.PatientID" class="btn btn-primary">
            <i class="ri-add-line me-2"></i>Book Appointment
        </a>
        <button class="btn btn-outline-secondary" onclick="printAppointments()">
            <i class="ri-printer-line me-2"></i>Print
        </button>
        <button class="btn btn-outline-info" onclick="exportAppointments()">
            <i class="ri-download-line me-2"></i>Export
        </button>
    </div>
}

@if (Model.Patient != null)
{
    <!-- Patient Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center">
                @if (!string.IsNullOrEmpty(Model.Patient.ProfileImage))
                {
                    <img src="@Model.Patient.ProfileImage" class="rounded-circle me-3" width="60" height="60" alt="Patient">
                }
                else
                {
                    <div class="rounded-circle bg-primary-light d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                        <i class="ri-user-line text-primary"></i>
                    </div>
                }
                <div class="flex-grow-1">
                    <h5 class="mb-1">@Model.Patient.FullName</h5>
                    <p class="text-muted mb-0">
                        Patient ID: P@Model.Patient.PatientID.ToString("D3") | 
                        Total Appointments: @Model.Patient.TotalAppointments | 
                        Last Visit: @(Model.Patient.LastVisit?.ToString("MMM dd, yyyy") ?? "Never")
                    </p>
                </div>
                <div>
                    <a href="~/Admin/PatientProfile?id=@Model.Patient.PatientID" class="btn btn-outline-primary">
                        <i class="ri-user-line me-2"></i>View Profile
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box md bg-primary-lighten rounded-5 me-3">
                            <i class="ri-calendar-line fs-4 text-primary"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">@Model.TotalAppointments</h4>
                            <p class="text-muted mb-0">Total Appointments</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box md bg-success-lighten rounded-5 me-3">
                            <i class="ri-check-line fs-4 text-success"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">@Model.CompletedAppointments</h4>
                            <p class="text-muted mb-0">Completed</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box md bg-warning-lighten rounded-5 me-3">
                            <i class="ri-time-line fs-4 text-warning"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">@Model.UpcomingAppointments</h4>
                            <p class="text-muted mb-0">Upcoming</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box md bg-danger-lighten rounded-5 me-3">
                            <i class="ri-close-line fs-4 text-danger"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">@Model.CancelledAppointments</h4>
                            <p class="text-muted mb-0">Cancelled</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointments List -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="ri-calendar-line me-2"></i>Appointment History
                </h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" onchange="filterAppointments(this.value)">
                        <option value="all">All Appointments</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="pending">Pending</option>
                    </select>
                    <input type="date" class="form-control form-control-sm" style="width: auto;" onchange="filterByDate(this.value)">
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="appointmentsTable">
                    <thead>
                        <tr>
                            <th>Appointment ID</th>
                            <th>Date & Time</th>
                            <th>Doctor</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Appointments.Any())
                        {
                            @foreach (var appointment in Model.Appointments)
                            {
                                <tr>
                                    <td>
                                        <strong>#APT@appointment.AppointmentID.ToString("D4")</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@appointment.AppointmentDate.ToString("MMM dd, yyyy")</strong><br>
                                            <small class="text-muted">@appointment.AppointmentDate.ToString("hh:mm tt")</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-info-light d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                                <i class="ri-user-heart-line text-info"></i>
                                            </div>
                                            <div>
                                                <strong>Dr. @appointment.DoctorName</strong><br>
                                                <small class="text-muted">@appointment.DoctorSpecialization</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info-light text-info">@appointment.AppointmentType</span>
                                    </td>
                                    <td>
                                        <span title="@appointment.Reason">@TruncateText(appointment.Reason, 30)</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-@GetStatusColor(appointment.Status)">@appointment.Status</span>
                                    </td>
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                                <i class="ri-more-2-line"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" href="#" onclick="viewAppointmentDetails(@appointment.AppointmentID)">
                                                        <i class="ri-eye-line me-2"></i>View Details
                                                    </a>
                                                </li>
                                                @if (appointment.Status == "Scheduled" || appointment.Status == "Confirmed")
                                                {
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="rescheduleAppointment(@appointment.AppointmentID)">
                                                            <i class="ri-calendar-line me-2"></i>Reschedule
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#" onclick="cancelAppointment(@appointment.AppointmentID)">
                                                            <i class="ri-close-line me-2"></i>Cancel
                                                        </a>
                                                    </li>
                                                }
                                                @if (appointment.Status == "Completed")
                                                {
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="viewPrescription(@appointment.AppointmentID)">
                                                            <i class="ri-medicine-bottle-line me-2"></i>View Prescription
                                                        </a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="ri-calendar-line fs-1 text-muted"></i>
                                    <p class="text-muted mt-2">No appointments found</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (Model.TotalPages > 1)
            {
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span class="text-muted">
                            Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) to 
                            @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalAppointments) of 
                            @Model.TotalAppointments appointments
                        </span>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="?patientId=@Model.Patient.PatientID&page=@(Model.CurrentPage - 1)">
                                    <i class="ri-arrow-left-s-line"></i>
                                </a>
                            </li>
                            @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="?patientId=@Model.Patient.PatientID&page=@i">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" href="?patientId=@Model.Patient.PatientID&page=@(Model.CurrentPage + 1)">
                                    <i class="ri-arrow-right-s-line"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="ri-user-line fs-1 text-muted"></i>
            <p class="text-muted mt-3">Patient not found</p>
            <a href="~/Admin/Patients" class="btn btn-primary mt-2">
                <i class="ri-arrow-left-line me-2"></i>Back to Patients
            </a>
        </div>
    </div>
}

@section Scripts {
    <script>
        function printAppointments() {
            window.print();
        }
        
        function exportAppointments() {
            // Implement export functionality
            alert('Export functionality will be implemented');
        }
        
        function filterAppointments(status) {
            // Implement filter functionality
            console.log('Filter by status:', status);
        }
        
        function filterByDate(date) {
            // Implement date filter
            console.log('Filter by date:', date);
        }
        
        function viewAppointmentDetails(id) {
            // Implement view details
            alert('View appointment details: ' + id);
        }
        
        function rescheduleAppointment(id) {
            // Implement reschedule
            alert('Reschedule appointment: ' + id);
        }
        
        function cancelAppointment(id) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                // Implement cancel
                alert('Cancel appointment: ' + id);
            }
        }
        
        function viewPrescription(id) {
            // Implement view prescription
            alert('View prescription for appointment: ' + id);
        }
    </script>
}

@functions {
    private string GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "completed" => "success",
            "confirmed" => "info",
            "scheduled" => "primary",
            "pending" => "warning",
            "cancelled" => "danger",
            "no-show" => "secondary",
            _ => "secondary"
        };
    }
    
    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text.Substring(0, maxLength) + "...";
    }
}
