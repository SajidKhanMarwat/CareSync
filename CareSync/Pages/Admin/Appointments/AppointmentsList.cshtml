@page "/Admin/Appointments/AppointmentsList"
@model CareSync.Pages.Admin.Appointments.AppointmentsListModel
@{
    ViewData["Title"] = "Appointments Management";
}

@section Breadcrumb {
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="~/Admin/Dashboard">
                <i class="ri-home-3-line"></i>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="~/Admin/Appointments">Appointments</a>
        </li>
        <li class="breadcrumb-item text-primary" aria-current="page">
            All Appointments
        </li>
    </ol>
}

@section PageActions {
    <div class="d-flex gap-2">
        <a href="~/Admin/Appointments/Book" class="btn btn-primary">
            <i class="ri-calendar-event-line me-2"></i>New Appointment
        </a>
        <button class="btn btn-outline-secondary" onclick="exportAppointments()">
            <i class="ri-download-line me-2"></i>Export
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                <i class="ri-filter-line me-2"></i>Filter
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterByStatus('all')">All Appointments</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByStatus('confirmed')">Confirmed</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByStatus('pending')">Pending</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByStatus('completed')">Completed</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterByStatus('cancelled')">Cancelled</a></li>
            </ul>
        </div>
    </div>
}

<!-- Statistics Cards -->
<div class="row gx-3 mb-4">
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-success rounded-circle me-3">
                        <div class="icon-box md bg-success-lighten rounded-5">
                            <i class="ri-calendar-check-line fs-4 text-success"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@Model.ConfirmedCount</h1>
                        <p class="m-0">Confirmed</p>
                        @if (Model.TotalAppointments > 0)
                        {
                            <small class="text-success">@((Model.ConfirmedCount * 100 / Model.TotalAppointments))%</small>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-warning rounded-circle me-3">
                        <div class="icon-box md bg-warning-lighten rounded-5">
                            <i class="ri-calendar-todo-line fs-4 text-warning"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@Model.PendingCount</h1>
                        <p class="m-0">Pending</p>
                        @if (Model.TotalAppointments > 0)
                        {
                            <small class="text-warning">@((Model.PendingCount * 100 / Model.TotalAppointments))%</small>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-primary rounded-circle me-3">
                        <div class="icon-box md bg-primary-lighten rounded-5">
                            <i class="ri-calendar-event-fill fs-4 text-primary"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@Model.CompletedCount</h1>
                        <p class="m-0">Completed</p>
                        @if (Model.TotalAppointments > 0)
                        {
                            <small class="text-primary">@((Model.CompletedCount * 100 / Model.TotalAppointments))%</small>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3 col-12">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="p-2 border border-danger rounded-circle me-3">
                        <div class="icon-box md bg-danger-lighten rounded-5">
                            <i class="ri-calendar-close-line fs-4 text-danger"></i>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <h1 class="lh-1">@Model.CancelledCount</h1>
                        <p class="m-0">Cancelled</p>
                        @if (Model.TotalAppointments > 0)
                        {
                            <small class="text-danger">@((Model.CancelledCount * 100 / Model.TotalAppointments))%</small>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Appointment Trends Chart -->
    <div class="col-xl-8 col-lg-7 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-line-chart-line me-2"></i>Appointment Trends
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-height">
                    <div id="appointmentTrends"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Department Distribution -->
    <div class="col-xl-4 col-lg-5 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-pie-chart-line me-2"></i>By Department
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-height">
                    <div id="departmentDistribution"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appointments Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="ri-calendar-line me-2"></i>All Appointments
                </h5>
                <div class="d-flex gap-2">
                    <div class="input-group" style="width: 250px;">
                        <input type="text" class="form-control" placeholder="Search appointments..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="ri-search-line"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="appointmentsTable">
                        <thead>
                            <tr>
                                <th>Appointment ID</th>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Department</th>
                                <th>Date & Time</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                    @if (Model.Appointments.Any())
                    {
                        @foreach (var appointment in Model.Appointments)
                        {
                            var statusBadgeClass = appointment.Status switch
                            {
                                "Approved" or "Confirmed" => "bg-success",
                                "Pending" => "bg-warning",
                                "Completed" => "bg-primary",
                                "Cancelled" or "Rejected" => "bg-danger",
                                "Created" => "bg-info",
                                _ => "bg-secondary"
                            };
                            
                            var departmentBadgeClass = (appointment.DoctorSpecialization ?? "General") switch
                            {
                                "Cardiology" => "bg-primary-light text-primary",
                                "Neurology" => "bg-warning-light text-warning",
                                "Orthopedics" => "bg-success-light text-success",
                                "Pediatrics" => "bg-info-light text-info",
                                _ => "bg-secondary-light text-secondary"
                            };
                            
                            var typeBadgeClass = appointment.AppointmentType switch
                            {
                                "Consultation" => "bg-info-light text-info",
                                "Follow-up" => "bg-secondary-light text-secondary",
                                "Emergency" => "bg-danger-light text-danger",
                                "Checkup" => "bg-success-light text-success",
                                _ => "bg-primary-light text-primary"
                            };
                            
                            <tr>
                                <td><span class="fw-bold text-primary">#APT@(appointment.AppointmentID.ToString("D3"))</span></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-primary-subtle me-2">
                                            <i class="ri-user-line text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@appointment.PatientName</h6>
                                            <small class="text-muted">ID: @appointment.PatientID</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-success-subtle me-2">
                                            <i class="ri-stethoscope-line text-success"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@appointment.DoctorName</h6>
                                            <small class="text-muted">@(appointment.DoctorSpecialization ?? "General")</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge @departmentBadgeClass">@(appointment.DoctorSpecialization ?? "General")</span></td>
                                <td>
                                    <div>
                                        <span class="fw-bold">@appointment.AppointmentDate.ToString("MMM dd, yyyy")</span><br>
                                        <small class="text-muted">@appointment.AppointmentTime.ToString("h:mm tt")</small>
                                    </div>
                                </td>
                                <td><span class="badge @typeBadgeClass">@appointment.AppointmentType</span></td>
                                <td><span class="badge @statusBadgeClass">@appointment.Status</span></td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="ri-more-2-line"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="viewDetails(@appointment.AppointmentID)"><i class="ri-eye-line me-2"></i>View Details</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="editAppointment(@appointment.AppointmentID)"><i class="ri-edit-line me-2"></i>Edit</a></li>
                                            @if (appointment.Status == "Pending" || appointment.Status == "Created")
                                            {
                                                <li><a class="dropdown-item" href="#" onclick="confirmAppointment(@appointment.AppointmentID)"><i class="ri-calendar-check-line me-2"></i>Confirm</a></li>
                                            }
                                            <li><hr class="dropdown-divider"></li>
                                            @if (appointment.Status != "Cancelled" && appointment.Status != "Completed")
                                            {
                                                <li><a class="dropdown-item text-danger" href="#" onclick="cancelAppointment(@appointment.AppointmentID)"><i class="ri-close-line me-2"></i>Cancel</a></li>
                                            }
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="ri-calendar-line text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mb-0 mt-2">No appointments found</p>
                                @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.StatusFilter))
                                {
                                    <a href="/Admin/Appointments" class="btn btn-sm btn-primary mt-2">Clear Filters</a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <span class="text-muted">
                            @if (Model.Appointments.Any())
                            {
                                <text>Showing @(((Model.CurrentPage - 1) * Model.PageSize) + 1) to @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalAppointments) of @Model.TotalAppointments appointments</text>
                            }
                            else
                            {
                                <text>No appointments to display</text>
                            }
                        </span>
                    </div>
                    @if (Model.TotalPages > 1)
                    {
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="?page=@(Model.CurrentPage - 1)&search=@Model.SearchTerm&status=@Model.StatusFilter">
                                        <i class="ri-arrow-left-s-line"></i>
                                    </a>
                                </li>
                                @for (int i = 1; i <= Math.Min(Model.TotalPages, 5); i++)
                                {
                                    <li class="page-item @(Model.CurrentPage == i ? "active" : "")">
                                        <a class="page-link" href="?page=@i&search=@Model.SearchTerm&status=@Model.StatusFilter">@i</a>
                                    </li>
                                }
                                @if (Model.TotalPages > 5)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "active" : "")">
                                        <a class="page-link" href="?page=@Model.TotalPages&search=@Model.SearchTerm&status=@Model.StatusFilter">@Model.TotalPages</a>
                                    </li>
                                }
                                <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                    <a class="page-link" href="?page=@(Model.CurrentPage + 1)&search=@Model.SearchTerm&status=@Model.StatusFilter">
                                        <i class="ri-arrow-right-s-line"></i>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- ApexCharts JS -->
    <script src="~/theme/vendor/apex/apexcharts.min.js"></script>
    
    <script>
        // Appointment Trends Chart
        @if (Model.MonthlyTrends.Any())
        {
            <text>
            var appointmentTrendsOptions = {
                chart: {
                    height: 300,
                    type: "line",
                    toolbar: {
                        show: false,
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                stroke: {
                    curve: "smooth",
                    width: 3
                },
                series: [{
                    name: 'Appointments',
                    data: [@string.Join(", ", Model.MonthlyTrends.Select(m => m.Count))]
                }],
                grid: {
                    borderColor: "#d8dee6",
                    strokeDashArray: 5,
                },
                xaxis: {
                    categories: [@Html.Raw(string.Join(", ", Model.MonthlyTrends.Select(m => $"\"{m.Month}\"")))],
                },
                colors: ['#0d6efd'],
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " appointments";
                        },
                    },
                },
            };

            var appointmentTrendsChart = new ApexCharts(document.querySelector("#appointmentTrends"), appointmentTrendsOptions);
            appointmentTrendsChart.render();
            </text>
        }

        // Department Distribution Chart
        @if (Model.DepartmentDistribution.Any())
        {
            <text>
            var departmentOptions = {
                chart: {
                    height: 300,
                    type: 'donut',
                },
                series: [@string.Join(", ", Model.DepartmentDistribution.Values)],
                labels: [@Html.Raw(string.Join(", ", Model.DepartmentDistribution.Keys.Select(k => $"\"{k}\"")))],
                colors: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#0dcaf0', '#6c757d'],
                legend: {
                    position: 'bottom',
                    horizontalAlign: 'center',
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    formatter: function () {
                                        return '@Model.TotalAppointments';
                                    }
                                }
                            }
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return Math.round(val) + "%"
                    }
                }
            };

            var departmentChart = new ApexCharts(document.querySelector("#departmentDistribution"), departmentOptions);
            departmentChart.render();
            </text>
        }

        // Filter functions
        function filterByStatus(status) {
            var url = new URL(window.location);
            if (status === 'all') {
                url.searchParams.delete('status');
            } else {
                url.searchParams.set('status', status);
            }
            url.searchParams.set('page', '1');
            window.location.href = url.toString();
        }

        function exportAppointments() {
            // TODO: Implement export functionality
            alert('Export functionality will be implemented soon');
        }
        
        function viewDetails(appointmentId) {
            // TODO: Implement view details
            console.log('View details for appointment:', appointmentId);
        }
        
        function editAppointment(appointmentId) {
            // TODO: Implement edit
            console.log('Edit appointment:', appointmentId);
        }
        
        function confirmAppointment(appointmentId) {
            if (confirm('Are you sure you want to confirm this appointment?')) {
                // TODO: Call API to confirm appointment
                console.log('Confirm appointment:', appointmentId);
            }
        }
        
        function cancelAppointment(appointmentId) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                // TODO: Call API to cancel appointment
                console.log('Cancel appointment:', appointmentId);
            }
        }
        
        // Search functionality
        document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                var url = new URL(window.location);
                if (this.value) {
                    url.searchParams.set('search', this.value);
                } else {
                    url.searchParams.delete('search');
                }
                url.searchParams.set('page', '1');
                window.location.href = url.toString();
            }
        });
    </script>

    <style>
        .chart-height {
            height: 300px;
        }
        
        .icon-box {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-box.md {
            width: 40px;
            height: 40px;
        }
        
        .bg-success-lighten {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        
        .bg-warning-lighten {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }
        
        .bg-danger-lighten {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        
        .bg-info-light {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
        
        .bg-secondary-light {
            background-color: rgba(108, 117, 125, 0.1) !important;
        }
        
        .text-info {
            color: #0dcaf0 !important;
        }
        
        .text-secondary {
            color: #6c757d !important;
        }
        
        .avatar-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .bg-primary-subtle {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        .bg-success-subtle {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
    </style>
}
