@page
@model CareSync.Pages.Auth.ResetPasswordModel
@{
    ViewData["Title"] = "Reset Password";
    Layout = "/Pages/Shared/Layouts/_AuthLayout.cshtml";
}

<div class="authentication-wrapper authentication-cover">
    <div class="authentication-inner row m-0">
        <!-- Left Section -->
        <div class="d-none d-lg-flex col-lg-7 col-xl-8 align-items-center p-5">
            <div class="w-100 d-flex justify-content-center">
                <img src="~/theme/images/pages/reset-password-light.png" class="img-fluid" alt="Reset Password" width="700">
            </div>
        </div>

        <!-- Right Section: Reset Password Form -->
        <div class="d-flex col-12 col-lg-5 col-xl-4 align-items-center authentication-bg p-sm-5 p-4">
            <div class="w-px-400 mx-auto">
                <!-- Logo -->
                <div class="app-brand mb-5">
                    <a href="/" class="app-brand-link gap-2">
                        <span class="app-brand-logo demo">
                            <i class="ri-hospital-line ri-2x text-primary"></i>
                        </span>
                        <span class="app-brand-text demo text-body fw-bold">CareSync</span>
                    </a>
                </div>

                <h4 class="mb-2">Reset Your Password ðŸ”’</h4>
                <p class="mb-4">
                    @if (Model.IsFirstTimeReset)
                    {
                        <text>Welcome to CareSync! Please set a new password for your account.</text>
                    }
                    else
                    {
                        <text>Enter your new password below to reset your account password.</text>
                    }
                </p>

                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="ri-error-warning-line me-2"></i>
                        @Model.ErrorMessage
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="ri-check-line me-2"></i>
                        @Model.SuccessMessage
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                <form method="post" class="mb-3">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    
                    <!-- Email/Username (readonly if coming from login) -->
                    <div class="mb-3">
                        <label asp-for="Input.Email" class="form-label">Email / Username</label>
                        <input asp-for="Input.Email" class="form-control" readonly="@Model.IsFirstTimeReset" placeholder="Enter your email or username" autofocus />
                        <span asp-validation-for="Input.Email" class="text-danger"></span>
                    </div>

                    <!-- Current Password (only for non-first-time reset) -->
                    @if (!Model.IsFirstTimeReset)
                    {
                        <div class="mb-3 form-password-toggle">
                            <label asp-for="Input.CurrentPassword" class="form-label">Current Password</label>
                            <div class="input-group input-group-merge">
                                <input asp-for="Input.CurrentPassword" class="form-control" type="password" placeholder="Enter current password" />
                                <span class="input-group-text cursor-pointer"><i class="ri-eye-off-line"></i></span>
                            </div>
                            <span asp-validation-for="Input.CurrentPassword" class="text-danger"></span>
                        </div>
                    }

                    <!-- New Password -->
                    <div class="mb-3 form-password-toggle">
                        <label asp-for="Input.NewPassword" class="form-label">New Password</label>
                        <div class="input-group input-group-merge">
                            <input asp-for="Input.NewPassword" class="form-control" type="password" placeholder="Enter new password" />
                            <span class="input-group-text cursor-pointer"><i class="ri-eye-off-line"></i></span>
                        </div>
                        <span asp-validation-for="Input.NewPassword" class="text-danger"></span>
                        <div class="form-text">
                            <small>Password must be at least 6 characters and contain uppercase, lowercase, number and special character.</small>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-3 form-password-toggle">
                        <label asp-for="Input.ConfirmPassword" class="form-label">Confirm New Password</label>
                        <div class="input-group input-group-merge">
                            <input asp-for="Input.ConfirmPassword" class="form-control" type="password" placeholder="Confirm new password" />
                            <span class="input-group-text cursor-pointer"><i class="ri-eye-off-line"></i></span>
                        </div>
                        <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="mb-3">
                        <div class="progress" style="height: 5px;">
                            <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="password-strength-text" class="form-text text-muted"></small>
                    </div>

                    <button type="submit" class="btn btn-primary d-grid w-100">
                        Reset Password
                    </button>
                </form>

                <div class="text-center">
                    <a href="/auth/login" class="d-flex align-items-center justify-content-center">
                        <i class="ri-arrow-left-line me-2"></i>
                        Back to Login
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Password toggle functionality
        document.querySelectorAll('.form-password-toggle .input-group-text').forEach(function(element) {
            element.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('ri-eye-off-line');
                    icon.classList.add('ri-eye-line');
                } else {
                    input.type = 'password';
                    icon.classList.remove('ri-eye-line');
                    icon.classList.add('ri-eye-off-line');
                }
            });
        });

        // Password strength checker
        const passwordInput = document.querySelector('#Input_NewPassword');
        const strengthBar = document.querySelector('#password-strength-bar');
        const strengthText = document.querySelector('#password-strength-text');

        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let strengthClass = '';
                let strengthMessage = '';

                if (password.length >= 8) strength++;
                if (password.match(/[a-z]/)) strength++;
                if (password.match(/[A-Z]/)) strength++;
                if (password.match(/[0-9]/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;

                switch(strength) {
                    case 0:
                    case 1:
                        strengthClass = 'bg-danger';
                        strengthMessage = 'Weak';
                        strengthBar.style.width = '20%';
                        break;
                    case 2:
                        strengthClass = 'bg-warning';
                        strengthMessage = 'Fair';
                        strengthBar.style.width = '40%';
                        break;
                    case 3:
                        strengthClass = 'bg-info';
                        strengthMessage = 'Good';
                        strengthBar.style.width = '60%';
                        break;
                    case 4:
                        strengthClass = 'bg-success';
                        strengthMessage = 'Strong';
                        strengthBar.style.width = '80%';
                        break;
                    case 5:
                        strengthClass = 'bg-success';
                        strengthMessage = 'Very Strong';
                        strengthBar.style.width = '100%';
                        break;
                }

                strengthBar.className = 'progress-bar ' + strengthClass;
                strengthText.textContent = strengthMessage;
            });
        }
    </script>
}
