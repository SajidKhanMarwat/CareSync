@page "/Lab/ResultEntry"
@model CareSync.Pages.Lab.ResultEntryModel
@{
    ViewData["Title"] = "Result Entry";
}

@section PageActions {
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-success">
            <i class="ri-save-line me-1"></i>Save Results
        </button>
        <button type="button" class="btn btn-primary">
            <i class="ri-upload-line me-1"></i>Upload File
        </button>
        <button type="button" class="btn btn-outline-info">
            <i class="ri-printer-line me-1"></i>Print Report
        </button>
    </div>
}

<!-- Result Entry Statistics -->
<div class="row gx-3 mb-3">
    <div class="col-xl-3 col-sm-6">
        <div class="card border rounded-5">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-box lg bg-warning-subtle rounded-5 me-3">
                        <i class="ri-edit-line fs-4 text-warning"></i>
                    </div>
                    <div>
                        <h4 class="text-warning mb-1">15</h4>
                        <small class="text-muted">Pending Entry</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="card border rounded-5">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-box lg bg-info-subtle rounded-5 me-3">
                        <i class="ri-draft-line fs-4 text-info"></i>
                    </div>
                    <div>
                        <h4 class="text-info mb-1">8</h4>
                        <small class="text-muted">Draft Results</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="card border rounded-5">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-box lg bg-success-subtle rounded-5 me-3">
                        <i class="ri-check-double-line fs-4 text-success"></i>
                    </div>
                    <div>
                        <h4 class="text-success mb-1">42</h4>
                        <small class="text-muted">Completed Today</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6">
        <div class="card border rounded-5">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="icon-box lg bg-danger-subtle rounded-5 me-3">
                        <i class="ri-alert-line fs-4 text-danger"></i>
                    </div>
                    <div>
                        <h4 class="text-danger mb-1">3</h4>
                        <small class="text-muted">Critical Values</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row gx-3">
    <div class="col-xl-8">
        <!-- Active Test Entry -->
        <div class="card mb-3">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="ri-test-tube-line me-2"></i>Test Result Entry
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" style="width: auto;" id="testSelect">
                            <option value="">Select Test to Enter Results</option>
                            <option value="test1">CBC - John Smith (T-2024-1156)</option>
                            <option value="test2">Lipid Profile - Maria Garcia (T-2024-1157)</option>
                            <option value="test3">Cardiac Enzymes - David Lee (T-2024-1158)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Test Information -->
                <div id="testInfo" class="test-info-panel border rounded-4 p-3 mb-4" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-2">Patient Information</h6>
                            <div class="patient-info">
                                <p class="mb-1"><strong>Name:</strong> <span id="patientName">John Smith</span></p>
                                <p class="mb-1"><strong>ID:</strong> <span id="patientId">P-2024-1156</span></p>
                                <p class="mb-1"><strong>Age:</strong> <span id="patientAge">45</span> | <strong>Gender:</strong> <span id="patientGender">Male</span></p>
                                <p class="mb-0"><strong>DOB:</strong> <span id="patientDob">Jan 15, 1979</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-2">Test Information</h6>
                            <div class="test-details">
                                <p class="mb-1"><strong>Test ID:</strong> <span id="testId">T-2024-1156</span></p>
                                <p class="mb-1"><strong>Test Type:</strong> <span id="testType">Complete Blood Count</span></p>
                                <p class="mb-1"><strong>Ordered By:</strong> <span id="orderedBy">Dr. Sarah Johnson</span></p>
                                <p class="mb-0"><strong>Sample Type:</strong> <span id="sampleType">EDTA Blood</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result Entry Form -->
                <div id="resultForm" style="display: none;">
                    <form>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">Hematology Results</h6>
                                <div class="mb-3">
                                    <label class="form-label">White Blood Cells (WBC)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.1" placeholder="4.5-11.0">
                                        <span class="input-group-text">×10³/μL</span>
                                    </div>
                                    <small class="text-muted">Reference: 4.5-11.0 ×10³/μL</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Red Blood Cells (RBC)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.01" placeholder="4.7-6.1">
                                        <span class="input-group-text">×10⁶/μL</span>
                                    </div>
                                    <small class="text-muted">Reference: 4.7-6.1 ×10⁶/μL (M), 4.2-5.4 (F)</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Hemoglobin (Hgb)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.1" placeholder="14.0-18.0">
                                        <span class="input-group-text">g/dL</span>
                                    </div>
                                    <small class="text-muted">Reference: 14.0-18.0 g/dL (M), 12.0-16.0 (F)</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Hematocrit (Hct)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.1" placeholder="42.0-52.0">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="text-muted">Reference: 42.0-52.0% (M), 37.0-48.0% (F)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3">Additional Parameters</h6>
                                <div class="mb-3">
                                    <label class="form-label">Platelets</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" placeholder="150-450">
                                        <span class="input-group-text">×10³/μL</span>
                                    </div>
                                    <small class="text-muted">Reference: 150-450 ×10³/μL</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mean Corpuscular Volume (MCV)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.1" placeholder="80-100">
                                        <span class="input-group-text">fL</span>
                                    </div>
                                    <small class="text-muted">Reference: 80-100 fL</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mean Corpuscular Hemoglobin (MCH)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.1" placeholder="27-32">
                                        <span class="input-group-text">pg</span>
                                    </div>
                                    <small class="text-muted">Reference: 27-32 pg</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Mean Corpuscular Hemoglobin Concentration (MCHC)</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" step="0.1" placeholder="32-36">
                                        <span class="input-group-text">g/dL</span>
                                    </div>
                                    <small class="text-muted">Reference: 32-36 g/dL</small>
                                </div>
                            </div>
                        </div>

                        <!-- Critical Values Alert -->
                        <div class="alert alert-warning" style="display: none;" id="criticalAlert">
                            <div class="d-flex align-items-center">
                                <i class="ri-alert-line me-2"></i>
                                <div>
                                    <strong>Critical Value Detected!</strong>
                                    <p class="mb-0">One or more values are outside critical limits. Please verify results and notify physician immediately.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="mb-3">
                            <label class="form-label">Laboratory Comments</label>
                            <textarea class="form-control" rows="3" placeholder="Enter any relevant comments about the test results..."></textarea>
                        </div>

                        <!-- Quality Control -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Quality Control Status</label>
                                <select class="form-select">
                                    <option value="passed">QC Passed</option>
                                    <option value="failed">QC Failed</option>
                                    <option value="repeat">Repeat Required</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Technician</label>
                                <select class="form-select">
                                    <option value="tech1">Alice Johnson</option>
                                    <option value="tech2">Bob Wilson</option>
                                    <option value="tech3">Carol Davis</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success">
                                <i class="ri-save-line me-1"></i>Save & Submit
                            </button>
                            <button type="button" class="btn btn-outline-primary">
                                <i class="ri-draft-line me-1"></i>Save as Draft
                            </button>
                            <button type="button" class="btn btn-outline-warning">
                                <i class="ri-eye-line me-1"></i>Preview Report
                            </button>
                            <button type="button" class="btn btn-outline-danger">
                                <i class="ri-close-line me-1"></i>Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recent Entries -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-history-line me-2"></i>Recent Result Entries
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Test ID</th>
                                <th>Patient</th>
                                <th>Test Type</th>
                                <th>Entry Time</th>
                                <th>Technician</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>T-2024-1155</td>
                                <td>
                                    <div>
                                        <h6 class="mb-0">Emma Wilson</h6>
                                        <small class="text-muted">P-2024-1159</small>
                                    </div>
                                </td>
                                <td>Lipid Profile</td>
                                <td>Nov 12, 2024 - 3:45 PM</td>
                                <td>Alice Johnson</td>
                                <td><span class="badge bg-success">Completed</span></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="ri-eye-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>T-2024-1154</td>
                                <td>
                                    <div>
                                        <h6 class="mb-0">Michael Brown</h6>
                                        <small class="text-muted">P-2024-1160</small>
                                    </div>
                                </td>
                                <td>Urine Analysis</td>
                                <td>Nov 12, 2024 - 2:20 PM</td>
                                <td>Bob Wilson</td>
                                <td><span class="badge bg-info">Draft</span></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-warning">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success">
                                            <i class="ri-send-plane-line"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4">
        <!-- Pending Tests -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-time-line me-2"></i>Pending Result Entry
                </h5>
            </div>
            <div class="card-body">
                <div class="pending-test-item border rounded-3 p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-0">CBC - John Smith</h6>
                            <small class="text-muted">T-2024-1156 | Due: 2 hours</small>
                        </div>
                        <span class="badge bg-warning">Pending</span>
                    </div>
                </div>
                <div class="pending-test-item border rounded-3 p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-0">Lipid Profile - Maria Garcia</h6>
                            <small class="text-muted">T-2024-1157 | Due: 4 hours</small>
                        </div>
                        <span class="badge bg-info">In Progress</span>
                    </div>
                </div>
                <div class="pending-test-item border rounded-3 p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-0">Cardiac Enzymes - David Lee</h6>
                            <small class="text-muted">T-2024-1158 | Due: 30 min</small>
                        </div>
                        <span class="badge bg-danger">STAT</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reference Ranges -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-book-line me-2"></i>Reference Ranges
                </h5>
            </div>
            <div class="card-body">
                <div class="reference-item mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-semibold">WBC</span>
                        <span class="text-muted">4.5-11.0 ×10³/μL</span>
                    </div>
                </div>
                <div class="reference-item mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-semibold">RBC (M)</span>
                        <span class="text-muted">4.7-6.1 ×10⁶/μL</span>
                    </div>
                </div>
                <div class="reference-item mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-semibold">Hgb (M)</span>
                        <span class="text-muted">14.0-18.0 g/dL</span>
                    </div>
                </div>
                <div class="reference-item mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-semibold">Platelets</span>
                        <span class="text-muted">150-450 ×10³/μL</span>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-info">View All Ranges</button>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="ri-dashboard-line me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success">
                        <i class="ri-upload-line me-2"></i>Bulk Upload
                    </button>
                    <button class="btn btn-outline-primary">
                        <i class="ri-download-line me-2"></i>Export Templates
                    </button>
                    <button class="btn btn-outline-info">
                        <i class="ri-calculator-line me-2"></i>Lab Calculator
                    </button>
                    <button class="btn btn-outline-warning">
                        <i class="ri-settings-line me-2"></i>QC Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Test selection handler
            document.getElementById('testSelect').addEventListener('change', function() {
                const testInfo = document.getElementById('testInfo');
                const resultForm = document.getElementById('resultForm');
                
                if (this.value) {
                    testInfo.style.display = 'block';
                    resultForm.style.display = 'block';
                    
                    // Update test information based on selection
                    if (this.value === 'test1') {
                        document.getElementById('patientName').textContent = 'John Smith';
                        document.getElementById('patientId').textContent = 'P-2024-1156';
                        document.getElementById('testType').textContent = 'Complete Blood Count';
                    }
                } else {
                    testInfo.style.display = 'none';
                    resultForm.style.display = 'none';
                }
            });
            
            // Critical value detection
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('blur', function() {
                    const value = parseFloat(this.value);
                    const criticalAlert = document.getElementById('criticalAlert');
                    
                    // Example critical value detection for WBC
                    if (this.placeholder.includes('4.5-11.0') && (value < 2.0 || value > 20.0)) {
                        criticalAlert.style.display = 'block';
                    }
                });
            });
            
            // Form actions
            document.querySelectorAll('form button').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.textContent.trim();
                    
                    switch(true) {
                        case action.includes('Save & Submit'):
                            alert('Results saved and submitted for review!');
                            break;
                        case action.includes('Save as Draft'):
                            alert('Results saved as draft.');
                            break;
                        case action.includes('Preview Report'):
                            alert('Opening report preview...');
                            break;
                        case action.includes('Cancel'):
                            if (confirm('Are you sure you want to cancel? Unsaved changes will be lost.')) {
                                document.querySelector('form').reset();
                            }
                            break;
                    }
                });
            });
            
            // Table actions
            document.querySelectorAll('.table button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const testId = row.cells[0].textContent;
                    const icon = this.querySelector('i').className;
                    
                    if (icon.includes('eye')) {
                        alert(`Viewing results for test ${testId}...`);
                    } else if (icon.includes('edit')) {
                        alert(`Editing results for test ${testId}...`);
                    } else if (icon.includes('send')) {
                        alert(`Submitting results for test ${testId}...`);
                    }
                });
            });
            
            // Quick actions
            document.querySelectorAll('.card:last-child .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.textContent.trim();
                    
                    switch(true) {
                        case action.includes('Bulk Upload'):
                            alert('Opening bulk upload interface...');
                            break;
                        case action.includes('Export Templates'):
                            alert('Downloading result entry templates...');
                            break;
                        case action.includes('Lab Calculator'):
                            alert('Opening laboratory calculator...');
                            break;
                        case action.includes('QC Settings'):
                            alert('Opening quality control settings...');
                            break;
                    }
                });
            });
        });
    </script>
}
